<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Quit Smoking Tracker</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  
  <link rel="stylesheet" href="styles.css?v=4" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="Pragma" content="no-cache" />
  <meta http-equiv="Expires" content="0" />
</head>
<body style="background: #ffffff !important; color: #1a1a1a !important;">
  <div class="container">
    <div id="onboardingScreen" class="onboarding-screen active">
      <div class="onboarding-content">
        <div class="onboarding-header">üö≠ –ë—Ä–æ—Å–∏—Ç—å –∫—É—Ä–∏—Ç—å</div>
        <div class="onboarding-subtitle">–¢–≤–æ–π –ø—É—Ç—å –∫ –∑–¥–æ—Ä–æ–≤–æ–π –∂–∏–∑–Ω–∏</div>
        <div class="onboarding-step" id="step1">
          <div class="step-title">üìä –°–∫–æ–ª—å–∫–æ —Å–∏–≥–∞—Ä–µ—Ç –≤ –¥–µ–Ω—å?</div>
          <input type="number" id="dailyLimitInput" min="1" max="100" value="5" class="modal-input" />
        </div>
        <div class="onboarding-step" id="step2" style="display:none;">
          <div class="step-title">‚è±Ô∏è –ò–Ω—Ç–µ—Ä–≤–∞–ª –º–µ–∂–¥—É –ø–µ—Ä–µ–∫—É—Ä–∞–º–∏ (–º–∏–Ω)?</div>
          <input type="number" id="minIntervalInput" min="5" max="300" value="45" class="modal-input" />
        </div>
        <div class="onboarding-step" id="step3" style="display:none;">
          <div class="step-title">üí∞ –¶–µ–Ω–∞ –ø–∞—á–∫–∏ —Å–∏–≥–∞—Ä–µ—Ç (‚ÇΩ)?</div>
          <input type="number" id="cigPriceInput" min="1" max="1000" value="200" class="modal-input" />
        </div>
        <div class="onboarding-step" id="step4" style="display:none;">
          <div class="step-title">üéØ –í—ã–±–µ—Ä–∏ –ø–ª–∞–Ω –æ—Ç–∫–∞–∑–∞</div>
          <div class="plan-buttons">
            <button class="plan-btn" data-plan="7">‚ö° –ë—ã—Å—Ç—Ä—ã–π (7 –¥–Ω)</button>
            <button class="plan-btn" data-plan="30">üìÖ –°—Ç–∞–Ω–¥–∞—Ä—Ç (30 –¥–Ω)</button>
            <button class="plan-btn" data-plan="60">üí™ –ò–Ω—Ç–µ–Ω—Å–∏–≤ (60 –¥–Ω)</button>
          </div>
        </div>
        <button class="btn btn-primary" id="nextOnboardingBtn" style="margin-top:24px;">–î–∞–ª–µ–µ ‚Üí</button>
      </div>
    </div>

    <div id="appScreen" style="display:none;">
      <div class="header">
        <h1>üö≠ –ë—Ä–æ—Å–∏—Ç—å –∫—É—Ä–∏—Ç—å</h1>
        <p>–¢—ã –º–æ–ª–æ–¥–µ—Ü! –ü—Ä–æ–¥–æ–ª–∂–∞–π!</p>
      </div>
      <div class="tip-card" id="tipCard" style="display:none;">
        <div class="tip-icon">üí°</div>
        <div class="tip-text" id="tipText"></div>
      </div>
      <div class="tabs-container">
        <button class="tab-btn active" data-tab="home">üìä –ì–ª–∞–≤–Ω–∞—è</button>
        <button class="tab-btn" data-tab="history">üìà –ò—Å—Ç–æ—Ä–∏—è</button>
        <button class="tab-btn" data-tab="achievements">üèÜ –î–æ—Å—Ç–∏–∂–µ–Ω–∏—è</button>
        <button class="tab-btn" data-tab="settings">‚öôÔ∏è –ü–∞—Ä–∞–º–µ—Ç—Ä—ã</button>
      </div>

      <div id="home" class="tab-content active">
        <div class="money-card">
          <div class="money-icon">üí∞</div>
          <div class="money-info">
            <div class="money-label">–°—ç–∫–æ–Ω–æ–º–ª–µ–Ω–æ</div>
            <div class="money-value" id="moneySaved">0 ‚ÇΩ</div>
            <div class="money-sublabel" id="cigsSaved">0 —à—Ç</div>
          </div>
        </div>
        <div class="stats">
          <div class="stat-row">
            <div class="stat-item">
              <div class="stat-value" id="daysClean">0</div>
              <div class="stat-label">–î–Ω–µ–π –±–µ–∑</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="todayCount">0</div>
              <div class="stat-label">–°–µ–≥–æ–¥–Ω—è</div>
            </div>
            <div class="stat-item">
              <div class="stat-value" id="weekAvg">0</div>
              <div class="stat-label">–ù–µ–¥–µ–ª—è</div>
            </div>
          </div>
        </div>
        <div class="daily-progress">
          <div class="progress-header">–õ–∏–º–∏—Ç: <span id="progressCount">0</span>/<span id="progressLimit">5</span></div>
          <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
          <div class="progress-status" id="progressStatus">‚úÖ –í –ø—Ä–µ–¥–µ–ª–∞—Ö</div>
        </div>
        <div class="timer-section">
          <div class="timer-label">–°–ª–µ–¥—É—é—â–∏–π –ø–µ—Ä–µ–∫—É—Ä —á–µ—Ä–µ–∑</div>
          <div class="timer-display" id="timerDisplay">00:00</div>
          <button class="btn btn-primary" id="smokeBtn">–ü–æ–∫—É—Ä–∏–ª üö¨</button>
          <div id="statusBadge" class="status-badge status-allowed">‚úì –ú–æ–∂–Ω–æ –∫—É—Ä–∏—Ç—å</div>
        </div>
        <div class="smokes-list">
          <div class="smokes-list-title">–°–µ–≥–æ–¥–Ω—è</div>
          <div id="todayList"></div>
        </div>
      </div>

      <div id="history" class="tab-content">
        <div class="chart-section">
          <div class="chart-title">üìä –ó–∞ –Ω–µ–¥–µ–ª—é</div>
          <div class="chart-bars" id="weeklyChart"></div>
        </div>
        <div class="calendar">
          <div class="calendar-header">
            <h3 id="calendarMonthYear">–ú–µ—Å—è—Ü</h3>
            <div class="calendar-nav">
              <button class="calendar-nav-btn" id="prevMonthBtn">‚Äπ</button>
              <button class="calendar-nav-btn" id="nextMonthBtn">‚Ä∫</button>
            </div>
          </div>
          <div class="weekdays">
            <div class="weekday">–ü–Ω</div><div class="weekday">–í—Ç</div><div class="weekday">–°—Ä</div>
            <div class="weekday">–ß—Ç</div><div class="weekday">–ü—Ç</div><div class="weekday">–°–±</div><div class="weekday">–í—Å</div>
          </div>
          <div class="days" id="calendarDays"></div>
        </div>
        <div id="selectedDateSmokes"></div>
      </div>

      <div id="achievements" class="tab-content">
        <div class="achievements-container" id="achievementsContainer"></div>
      </div>

      <div id="settings" class="tab-content">
        <div class="settings-section">
          <div class="settings-row">
            <span class="settings-label">–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç</span>
            <button class="btn-edit" id="editLimitBtn">–ò–∑–º–µ–Ω–∏—Ç—å</button>
          </div>
          <div class="settings-row">
            <span class="settings-value" id="currentLimitDisplay">5</span>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-row">
            <span class="settings-label">–ò–Ω—Ç–µ—Ä–≤–∞–ª (–º–∏–Ω)</span>
            <button class="btn-edit" id="editIntervalBtn">–ò–∑–º–µ–Ω–∏—Ç—å</button>
          </div>
          <div class="settings-row">
            <span class="settings-value" id="currentIntervalDisplay">45</span>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-row">
            <span class="settings-label">–¶–µ–Ω–∞ –ø–∞—á–∫–∏ (‚ÇΩ)</span>
            <button class="btn-edit" id="editPriceBtn">–ò–∑–º–µ–Ω–∏—Ç—å</button>
          </div>
          <div class="settings-row">
            <span class="settings-value" id="currentPriceDisplay">200</span>
          </div>
        </div>
        <div class="settings-section">
          <div class="settings-row">
            <span class="settings-label">–°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞</span>
          </div>
          <div style="padding:12px 0;">
            <div class="stats-grid">
              <div class="stat-card"><div class="stat-card-value" id="totalSmokes">0</div><div class="stat-card-label">–í—Å–µ–≥–æ</div></div>
              <div class="stat-card"><div class="stat-card-value" id="avgDay">0</div><div class="stat-card-label">–í –¥–µ–Ω—å</div></div>
            </div>
          </div>
        </div>
        <button class="btn btn-secondary" id="exportBtn">üì• –≠–∫—Å–ø–æ—Ä—Ç</button>
        <button class="btn btn-secondary" id="resetBtn">üîÑ –°–±—Ä–æ—Å</button>
      </div>
    </div>
  </div>

  <div id="reasonModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">–ü—Ä–∏—á–∏–Ω–∞?</div>
      <div class="modal-body">
        <label class="modal-label">–í—ã–±–µ—Ä–∏ –∏–ª–∏ –Ω–∞–ø–∏—à–∏:</label>
        <div class="reason-buttons">
          <button class="reason-btn" data-reason="–°—Ç—Ä–µ—Å—Å">üò∞ –°—Ç—Ä–µ—Å—Å</button>
          <button class="reason-btn" data-reason="–°–æ—Ü–∏—É–º">üë• –õ—é–¥–∏</button>
          <button class="reason-btn" data-reason="–°–∫—É–∫–∞">üòë –°–∫—É–∫–∞</button>
          <button class="reason-btn" data-reason="–ü—Ä–∏–≤—ã—á–∫–∞">üîÑ –ü—Ä–∏–≤—ã—á–∫–∞</button>
          <button class="reason-btn" data-reason="–ê–ª–∫–æ–≥–æ–ª—å">üç∫ –°–ø–∏—Ä—Ç–Ω–æ–µ</button>
          <button class="reason-btn" data-reason="–ö–æ—Ñ–µ">‚òï –ö–æ—Ñ–µ</button>
        </div>
        <textarea class="modal-input" id="reasonInput" placeholder="–ò–ª–∏ –Ω–∞–ø–∏—à–∏..."></textarea>
      </div>
      <div class="modal-buttons">
        <button class="btn btn-secondary" id="cancelReasonBtn">–û—Ç–º–µ–Ω–∞</button>
        <button class="btn btn-primary" id="confirmReasonBtn">OK</button>
      </div>
    </div>
  </div>

  <script>
    const TIPS = ["–ü–µ–π –≤–æ–¥—É!", "–ó–∞–π–º–∏—Å—å —Å–ø–æ—Ä—Ç–æ–º –Ω–∞ 10 –º–∏–Ω", "–ü–æ–∑–≤–æ–Ω–∏ –¥—Ä—É–≥—É", "–ü—Ä–æ–≥—É–ª–∫–∞ –Ω–∞ –≤–æ–∑–¥—É—Ö–µ", "–ñ–≤–∞—á–∫–∞ –±–µ–∑ —Å–∞—Ö–∞—Ä–∞", "–ß–µ—Ä–µ–∑ 3-4 –¥–Ω—è —Ç—è–≥–∞ –æ—Å–ª–∞–±–ª—è–µ—Ç—Å—è!", "–ö–∞–∂–¥—ã–π –¥–µ–Ω—å - –ø–æ–±–µ–¥–∞!", "–ú–µ–¥–ª–µ–Ω–Ω–æ–µ –¥—ã—Ö–∞–Ω–∏–µ 5 —Ä–∞–∑", "–û—Ä–≥–∞–Ω–∏–∑–º –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è", "–¢—ã —Å–ø—Ä–∞–≤–∏—à—å—Å—è!"];
    const ACHIEVEMENTS = [
      { id:1, name:"–ü–µ—Ä–≤—ã–π —à–∞–≥", desc:"1 –¥–µ–Ω—å", icon:"üë£", unlocked:false },
      { id:2, name:"–ù–µ–¥–µ–ª—è!", desc:"7 –¥–Ω–µ–π", icon:"üìÖ", unlocked:false },
      { id:3, name:"–ú–µ—Å—è—Ü!", desc:"30 –¥–Ω–µ–π", icon:"üéâ", unlocked:false },
      { id:4, name:"–î–≤–∞!", desc:"60 –¥–Ω–µ–π", icon:"üí™", unlocked:false },
      { id:5, name:"–í–µ—Ä–Ω–æ—Å—Ç—å", desc:"5 –¥–Ω", icon:"‚úÖ", unlocked:false },
      { id:6, name:"–ë–æ–≥–∞—á", desc:"1000 ‚ÇΩ", icon:"üí∞", unlocked:false }
    ];

    let state = {
      smokeEvents: [],
      minIntervalMinutes: 45,
      dailyLimit: 5,
      cigPrice: 200,
      lastSmokeTime: null,
      onboardingComplete: false,
      achievements: ACHIEVEMENTS.map(a => ({...a})),
      plan: null
    };

    let currentCalendarDate = new Date();
    let selectedReason = null;
    let currentStep = 1;

    function loadState() {
      const stored = localStorage.getItem("quitSmoking_v1");
      if (!stored) return;
      try {
        const p = JSON.parse(stored);
        state.smokeEvents = (p.smokeEvents || []).map(e => ({timestamp: new Date(e.timestamp), reason: e.reason || "–ë–µ–∑ –ø—Ä–∏—á–∏–Ω—ã"}));
        state.minIntervalMinutes = p.minIntervalMinutes ?? 45;
        state.dailyLimit = p.dailyLimit ?? 5;
        state.cigPrice = p.cigPrice ?? 200;
        state.onboardingComplete = p.onboardingComplete ?? false;
        state.achievements = p.achievements || ACHIEVEMENTS.map(a => ({...a}));
        state.plan = p.plan ?? null;
        state.lastSmokeTime = p.lastSmokeTime ? new Date(p.lastSmokeTime) : null;
      } catch(e) { console.error("Load error", e); }
    }
    
    function saveState() {
      localStorage.setItem("quitSmoking_v1", JSON.stringify({
        smokeEvents: state.smokeEvents.map(e => ({timestamp: e.timestamp.toISOString(), reason: e.reason})),
        minIntervalMinutes: state.minIntervalMinutes,
        dailyLimit: state.dailyLimit,
        cigPrice: state.cigPrice,
        onboardingComplete: state.onboardingComplete,
        achievements: state.achievements,
        lastSmokeTime: state.lastSmokeTime ? state.lastSmokeTime.toISOString() : null,
        plan: state.plan
      }));
    }

    Telegram.WebApp.ready();
    Telegram.WebApp.expand();

    const nextBtn = document.getElementById("nextOnboardingBtn");
    nextBtn.addEventListener("click", () => {
      if (currentStep === 1) {
        state.dailyLimit = parseInt(document.getElementById("dailyLimitInput").value, 10) || 5;
        document.getElementById("step1").style.display = "none";
        document.getElementById("step2").style.display = "block";
        currentStep = 2; return;
      }
      if (currentStep === 2) {
        state.minIntervalMinutes = parseInt(document.getElementById("minIntervalInput").value, 10) || 45;
        document.getElementById("step2").style.display = "none";
        document.getElementById("step3").style.display = "block";
        currentStep = 3; return;
      }
      if (currentStep === 3) {
        state.cigPrice = parseInt(document.getElementById("cigPriceInput").value, 10) || 200;
        document.getElementById("step3").style.display = "none";
        document.getElementById("step4").style.display = "block";
        currentStep = 4; return;
      }
      if (currentStep === 4) {
        const selected = document.querySelector(".plan-btn.selected");
        if (!selected) { alert("–í—ã–±–µ—Ä–∏—Ç–µ –ø–ª–∞–Ω –æ—Ç–∫–∞–∑–∞ (7, 30 –∏–ª–∏ 60 –¥–Ω–µ–π)"); return; }
        state.plan = parseInt(selected.getAttribute("data-plan"), 10);
        state.onboardingComplete = true;
        saveState();
        document.getElementById("onboardingScreen").style.display = "none";
        document.getElementById("appScreen").style.display = "block";
        currentCalendarDate = new Date();
        renderCalendar();
        renderWeeklyChart();
        showTip();
        updateUI();
      }
    });

    document.querySelectorAll(".plan-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        document.querySelectorAll(".plan-btn").forEach(b => b.classList.remove("selected"));
        btn.classList.add("selected");
      });
    });

    document.querySelectorAll(".tab-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const tab = btn.getAttribute("data-tab");
        document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
        document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));
        document.getElementById(tab).classList.add("active");
        btn.classList.add("active");
        if (tab === "history") { currentCalendarDate = new Date(); renderCalendar(); renderWeeklyChart(); }
        if (tab === "achievements") { renderAchievements(); }
      });
    });

    function showTip() {
      if (Math.random() > 0.4) {
        const tip = TIPS[Math.floor(Math.random() * TIPS.length)];
        document.getElementById("tipText").textContent = tip;
        document.getElementById("tipCard").style.display = "flex";
      }
    }

    const reasonModal = document.getElementById("reasonModal");
    const reasonButtons = document.querySelectorAll(".reason-btn");
    reasonButtons.forEach(b => {
      b.addEventListener("click", () => {
        reasonButtons.forEach(x => x.classList.remove("selected"));
        b.classList.add("selected");
        selectedReason = b.getAttribute("data-reason");
        document.getElementById("reasonInput").value = selectedReason;
      });
    });
    document.getElementById("cancelReasonBtn").addEventListener("click", () => reasonModal.classList.remove("active"));
    document.getElementById("confirmReasonBtn").addEventListener("click", () => {
      const now = new Date();
      state.smokeEvents.push({timestamp: now, reason: selectedReason || document.getElementById("reasonInput").value || "–ë–µ–∑ –ø—Ä–∏—á–∏–Ω—ã"});
      state.lastSmokeTime = now;
      saveState();
      updateUI();
      reasonModal.classList.remove("active");
    });

    document.getElementById("smokeBtn").addEventListener("click", () => {
      const now = new Date();
      if (state.lastSmokeTime) {
        const diffMin = (now - state.lastSmokeTime) / (1000*60);
        if (diffMin < state.minIntervalMinutes) {
          selectedReason = null;
          document.getElementById("reasonInput").value = "";
          reasonButtons.forEach(b => b.classList.remove("selected"));
          reasonModal.classList.add("active");
          return;
        }
      }
      state.smokeEvents.push({timestamp: now, reason: "–ü–æ –≥—Ä–∞—Ñ–∏–∫—É"});
      state.lastSmokeTime = now;
      saveState();
      updateUI();
    });

    document.getElementById("editIntervalBtn").addEventListener("click", () => {
      const v = prompt("–ò–Ω—Ç–µ—Ä–≤–∞–ª (–º–∏–Ω):", state.minIntervalMinutes);
      if (v && !isNaN(v)) { state.minIntervalMinutes = parseInt(v, 10); saveState(); updateUI(); }
    });
    document.getElementById("editLimitBtn").addEventListener("click", () => {
      const v = prompt("–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç:", state.dailyLimit);
      if (v && !isNaN(v)) { state.dailyLimit = parseInt(v, 10); saveState(); updateUI(); }
    });
    document.getElementById("editPriceBtn").addEventListener("click", () => {
      const v = prompt("–¶–µ–Ω–∞ –ø–∞—á–∫–∏ (‚ÇΩ):", state.cigPrice);
      if (v && !isNaN(v)) { state.cigPrice = parseInt(v, 10); saveState(); updateUI(); }
    });
    document.getElementById("resetBtn").addEventListener("click", () => {
      if (confirm("–£–¥–∞–ª–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ?")) { localStorage.removeItem("quitSmoking_v1"); location.reload(); }
    });
    document.getElementById("exportBtn").addEventListener("click", () => {
      const dataStr = JSON.stringify(state, null, 2);
      const blob = new Blob([dataStr], {type: "application/json"});
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = `smoking-tracker-${new Date().toISOString().split("T")[0]}.json`;
      a.click();
    });

    function getDateString(d) { const y=d.getFullYear(); const m=String(d.getMonth()+1).padStart(2,"0"); const dd=String(d.getDate()).padStart(2,"0"); return `${y}-${m}-${dd}`; }
    function isSameDay(a,b) { return getDateString(a) === getDateString(b); }
    function eventsFor(date) { return state.smokeEvents.filter(e => isSameDay(e.timestamp, date)); }
    function dayStats(date) { const c = eventsFor(date).length; return {count:c, isSuccess: c <= state.dailyLimit}; }

    function renderCalendar() {
      const y = currentCalendarDate.getFullYear();
      const m = currentCalendarDate.getMonth();
      const months = ["–Ø–Ω–≤–∞—Ä—å","–§–µ–≤—Ä–∞–ª—å","–ú–∞—Ä—Ç","–ê–ø—Ä–µ–ª—å","–ú–∞–π","–ò—é–Ω—å","–ò—é–ª—å","–ê–≤–≥—É—Å—Ç","–°–µ–Ω—Ç—è–±—Ä—å","–û–∫—Ç—è–±—Ä—å","–ù–æ—è–±—Ä—å","–î–µ–∫–∞–±—Ä—å"];
      document.getElementById("calendarMonthYear").textContent = `${months[m]} ${y}`;
      const firstDay = new Date(y,m,1).getDay();
      const dim = new Date(y,m+1,0).getDate();
      const dimPrev = new Date(y,m,0).getDate();
      const cont = document.getElementById("calendarDays");
      cont.innerHTML = "";

      for(let i = firstDay===0?6:firstDay-1; i>0; i--) { const el = document.createElement("div"); el.className = "day other-month"; el.textContent = dimPrev - i + 1; cont.appendChild(el); }

      const today = new Date();
      for(let d=1; d<=dim; d++) {
        const date = new Date(y,m,d);
        const el = document.createElement("div");
        el.className = "day";
        el.textContent = d;
        const {count, isSuccess} = dayStats(date);
        if(count>0) el.classList.add(isSuccess ? "success" : "danger");
        if(isSameDay(date, today)) el.classList.add("selected");
        el.addEventListener("click", () => renderDateDetails(date, eventsFor(date)));
        cont.appendChild(el);
      }

      const total = cont.children.length;
      for(let d=1; d<=42-total; d++) { const el = document.createElement("div"); el.className = "day other-month"; el.textContent = d; cont.appendChild(el); }
    }

    function renderDateDetails(date, events) {
      const c = document.getElementById("selectedDateSmokes");
      const dateStr = date.toLocaleDateString("ru-RU", {day:"numeric", month:"long", weekday:"long"});
      const {count, isSuccess} = dayStats(date);
      let html = `<div class="smokes-list"><div class="smokes-list-title">${dateStr}</div>`;
      if(count===0) { html += `<div class="empty-state">–õ–∏–º–∏—Ç –≤—ã–ø–æ–ª–Ω–µ–Ω ‚úÖ</div>`; }
      else {
        html += `<div class="empty-state">${count}/${state.dailyLimit} ${isSuccess ? "‚úÖ" : "‚ö†Ô∏è"}</div>`;
        events.forEach((e,i) => {
          const t = e.timestamp.toLocaleTimeString("ru-RU", {hour:"2-digit", minute:"2-digit"});
          let itv = "";
          if(i>0) { const diff = Math.round((e.timestamp - events[i-1].timestamp) / (1000*60)); itv = ` (+${diff})`; }
          html += `<div class="smoke-item"><div class="smoke-item-time">${t}${itv}</div><div class="smoke-item-reason">üìù ${e.reason || "–ë–µ–∑ –ø—Ä–∏—á–∏–Ω—ã"}</div></div>`;
        });
      }
      html += `</div>`;
      c.innerHTML = html;
    }

    function renderWeeklyChart() {
      const chart = document.getElementById("weeklyChart");
      const days = ["–ü–Ω","–í—Ç","–°—Ä","–ß—Ç","–ü—Ç","–°–±","–í—Å"];
      const today = new Date();
      let html = "";
      for(let i=6; i>=0; i--) {
        const d = new Date(today);
        d.setDate(d.getDate() - i);
        const cnt = eventsFor(d).length;
        const name = days[(d.getDay()+6) % 7];
        const perc = Math.max(4, Math.min(100, (cnt/state.dailyLimit)*100));
        const color = cnt <= state.dailyLimit ? "#2e7d32" : "#c62828";
        html += `<div class="chart-bar-container"><div class="chart-bar" style="height:${perc}%;background:${color};"></div><div class="chart-label">${name}</div><div class="chart-value">${cnt}</div></div>`;
      }
      chart.innerHTML = html;
    }

    function updateTimer() {
      if (!state.lastSmokeTime) { document.getElementById("timerDisplay").textContent = "00:00"; return; }
      const now = new Date();
      const since = (now - state.lastSmokeTime) / (1000*60);
      if (since >= state.minIntervalMinutes) { document.getElementById("timerDisplay").textContent = "00:00"; return; }
      const next = new Date(state.lastSmokeTime.getTime() + state.minIntervalMinutes*60*1000);
      const rem = Math.max(0, (next - now) / 1000);
      const m = Math.floor(rem/60);
      const s = Math.floor(rem % 60);
      document.getElementById("timerDisplay").textContent = `${String(m).padStart(2,"0")}:${String(s).padStart(2,"0")}`;
    }

    function getCleanDays() {
      const today = new Date();
      if (state.smokeEvents.length === 0) return 0;
      const last = new Date(state.smokeEvents[state.smokeEvents.length-1].timestamp);
      return Math.floor((today - last) / (1000*60*60*24));
    }

    function updateUI() {
      const today = new Date();
      const todayEvents = eventsFor(today);
      const moneySaved = Math.floor(state.smokeEvents.length * (state.cigPrice / 20));
      const daysClean = getCleanDays();

      document.getElementById("moneySaved").textContent = `${moneySaved} ‚ÇΩ`;
      document.getElementById("cigsSaved").textContent = `${state.smokeEvents.length} —à—Ç`;
      document.getElementById("daysClean").textContent = daysClean;
      document.getElementById("todayCount").textContent = todayEvents.length;

      const weekCount = state.smokeEvents.filter(e => (today - new Date(e.timestamp)) / (1000*60*60*24) < 7).length;
      document.getElementById("weekAvg").textContent = Math.round(weekCount / 7);

      const perc = Math.min(100, (todayEvents.length / state.dailyLimit) * 100);
      document.getElementById("progressFill").style.width = `${perc}%`;
      document.getElementById("progressCount").textContent = todayEvents.length;
      document.getElementById("progressLimit").textContent = state.dailyLimit;
      document.getElementById("progressStatus").textContent = todayEvents.length <= state.dailyLimit ? "‚úÖ –í –ø—Ä–µ–¥–µ–ª–∞—Ö" : "‚ö†Ô∏è –ü—Ä–µ–≤—ã—à–µ–Ω!";

      const smokeBtn = document.getElementById("smokeBtn");
      const statusBadge = document.getElementById("statusBadge");
      let disabled = false;
      let cls = "status-allowed";
      let txt = "‚úì –ú–æ–∂–Ω–æ –∫—É—Ä–∏—Ç—å";
      if (state.lastSmokeTime) {
        const since = (today - state.lastSmokeTime) / (1000*60);
        if (since < state.minIntervalMinutes) {
          disabled = true;
          const rem = Math.ceil(state.minIntervalMinutes - since);
          if (rem > 5) { cls = "status-wait"; txt = `‚è≥ ${rem} –º–∏–Ω`; } else { cls = "status-soon"; txt = `‚è±Ô∏è ${rem} –º–∏–Ω`; }
        }
      }
      smokeBtn.disabled = disabled;
      statusBadge.className = `status-badge ${cls}`;
      statusBadge.textContent = txt;

      const todayList = document.getElementById("todayList");
      todayList.innerHTML = todayEvents.length === 0
        ? '<div class="empty-state">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π üéâ</div>'
        : todayEvents.map((e,i) => {
            const t = e.timestamp.toLocaleTimeString("ru-RU", {hour:"2-digit", minute:"2-digit"});
            let itv = "";
            if (i>0) { const diff = Math.round((e.timestamp - todayEvents[i-1].timestamp) / (1000*60)); itv = ` (+${diff})`; }
            return `<div class="smoke-item"><div class="smoke-item-time">${t}${itv}</div><div class="smoke-item-reason">üìù ${e.reason || "–ë–µ–∑ –ø—Ä–∏—á–∏–Ω—ã"}</div></div>`;
          }).join("");

      document.getElementById("currentLimitDisplay").textContent = state.dailyLimit;
      document.getElementById("currentIntervalDisplay").textContent = state.minIntervalMinutes;
      document.getElementById("currentPriceDisplay").textContent = state.cigPrice;
      document.getElementById("totalSmokes").textContent = state.smokeEvents.length;

      if (state.smokeEvents.length > 0) {
        const first = new Date(state.smokeEvents[0].timestamp);
        const last = new Date(state.smokeEvents[state.smokeEvents.length-1].timestamp);
        const span = Math.max(1, Math.floor((last - first) / (1000*60*60*24))) + 1;
        document.getElementById("avgDay").textContent = Math.round(state.smokeEvents.length / span);
      } else {
        document.getElementById("avgDay").textContent = "0";
      }

      saveState();
    }

    function renderAchievements() {
      const container = document.getElementById("achievementsContainer");
      const daysClean = getCleanDays();
      const moneySaved = Math.floor(state.smokeEvents.length * (state.cigPrice / 20));
      
      state.achievements.forEach(a => {
        if (a.id === 1 && daysClean >= 1) a.unlocked = true;
        if (a.id === 2 && daysClean >= 7) a.unlocked = true;
        if (a.id === 3 && daysClean >= 30) a.unlocked = true;
        if (a.id === 4 && daysClean >= 60) a.unlocked = true;
        if (a.id === 6 && moneySaved >= 1000) a.unlocked = true;
      });

      let html = "";
      state.achievements.forEach(a => {
        html += `<div class="achievement-card ${a.unlocked ? 'unlocked' : 'locked'}"><div class="achievement-icon">${a.icon}</div><div class="achievement-name">${a.name}</div><div class="achievement-desc">${a.desc}</div></div>`;
      });
      
      container.innerHTML = html;
    }

    document.getElementById("prevMonthBtn").addEventListener("click", () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth()-1); renderCalendar(); });
    document.getElementById("nextMonthBtn").addEventListener("click", () => { currentCalendarDate.setMonth(currentCalendarDate.getMonth()+1); renderCalendar(); });

    loadState();
    if (state.onboardingComplete) {
      document.getElementById("onboardingScreen").style.display = "none";
      document.getElementById("appScreen").style.display = "block";
      currentCalendarDate = new Date();
      renderCalendar();
      renderWeeklyChart();
      showTip();
    }
    updateUI();
    setInterval(updateTimer, 1000);
    setInterval(updateUI, 10000);
  </script>
</body>
</html>
